name: Build NixOS ISOs

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  release:
    types: [ created ]

jobs:
  build-beginner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          nix_path: nixpkgs=channel:nixos-25.11
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: nixos-custom-iso
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: ${{ github.event_name == 'pull_request' }}

      - name: Build Beginner ISO
        run: |
          nix build .#nixosConfigurations.iso-beginner.config.system.build.isoImage

      - name: Get ISO filename
        id: iso-name
        run: |
          ISO_PATH=$(ls result/iso/*.iso)
          ISO_NAME=$(basename "$ISO_PATH")
          echo "name=$ISO_NAME" >> $GITHUB_OUTPUT
          echo "path=$ISO_PATH" >> $GITHUB_OUTPUT

      - name: Upload Beginner ISO
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.iso-name.outputs.name }}
          path: ${{ steps.iso-name.outputs.path }}
          retention-days: 30

  build-minimal:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          nix_path: nixpkgs=channel:nixos-25.11
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: nixos-custom-iso
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: ${{ github.event_name == 'pull_request' }}

      - name: Build Minimal ISO
        run: |
          nix build .#nixosConfigurations.iso-minimal.config.system.build.isoImage

      - name: Get ISO filename
        id: iso-name
        run: |
          ISO_PATH=$(ls result/iso/*.iso)
          ISO_NAME=$(basename "$ISO_PATH")
          echo "name=$ISO_NAME" >> $GITHUB_OUTPUT
          echo "path=$ISO_PATH" >> $GITHUB_OUTPUT

      - name: Upload Minimal ISO
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.iso-name.outputs.name }}
          path: ${{ steps.iso-name.outputs.path }}
          retention-days: 30

  build-hyprland:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          nix_path: nixpkgs=channel:nixos-25.11
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://nix-community.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: nixos-custom-iso
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: ${{ github.event_name == 'pull_request' }}

      - name: Build Hyprland ISO
        run: |
          nix build .#nixosConfigurations.iso-hyprland.config.system.build.isoImage

      - name: Get ISO filename
        id: iso-name
        run: |
          ISO_PATH=$(ls result/iso/*.iso)
          ISO_NAME=$(basename "$ISO_PATH")
          echo "name=$ISO_NAME" >> $GITHUB_OUTPUT
          echo "path=$ISO_PATH" >> $GITHUB_OUTPUT

      - name: Upload Hyprland ISO
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.iso-name.outputs.name }}
          path: ${{ steps.iso-name.outputs.path }}
          retention-days: 30

  release:
    needs: [build-beginner, build-minimal, build-hyprland]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: isos

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: isos/**/*.iso
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
